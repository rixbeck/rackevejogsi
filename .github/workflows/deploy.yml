name: Deploy (Apache)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install rsync
        run: sudo apt-get update && sudo apt-get install -y rsync

      - name: Start ssh-agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}

      - name: Add known hosts
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          if [[ -n "${{ secrets.DEPLOY_KNOWN_HOSTS }}" ]]; then
            echo "${{ secrets.DEPLOY_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts
          else
            echo "DEPLOY_KNOWN_HOSTS is empty; using ssh-keyscan (less secure)." >&2
            ssh-keyscan -p "${{ secrets.DEPLOY_PORT }}" "${{ secrets.DEPLOY_HOST }}" >> ~/.ssh/known_hosts
          fi
          chmod 600 ~/.ssh/known_hosts

      - name: Deploy via rsync over SSH
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          set -euo pipefail

          : "${DEPLOY_HOST:?Missing DEPLOY_HOST}"
          : "${DEPLOY_PORT:?Missing DEPLOY_PORT}"
          : "${DEPLOY_USER:?Missing DEPLOY_USER}"
          : "${DEPLOY_PATH:?Missing DEPLOY_PATH}"

          echo "Resolving DEPLOY_HOST..."
          getent hosts "${DEPLOY_HOST}" || true

          rsync -az --delete --itemize-changes \
            --exclude '.git/' \
            --exclude '.github/' \
            --exclude 'deploy/' \
            --chmod=Du=rwx,Dg=rx,Do=rx,Fu=rw,Fg=r,Fo=r \
            --rsync-path "mkdir -p '${DEPLOY_PATH}' && rsync" \
            -e "ssh -p ${DEPLOY_PORT} -o StrictHostKeyChecking=yes" \
            ./ "${DEPLOY_USER}@${DEPLOY_HOST}:${DEPLOY_PATH}/"

      - name: Verify remote deployment directory
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          set -euo pipefail
          ssh -p "${DEPLOY_PORT}" -o StrictHostKeyChecking=yes "${DEPLOY_USER}@${DEPLOY_HOST}" \
            "set -e; echo HOSTNAME=\$(hostname); id; pwd; echo 'DEPLOY_PATH=${DEPLOY_PATH}'; ls -la '${DEPLOY_PATH}' | sed -n '1,120p'; echo '---'; find '${DEPLOY_PATH}' -maxdepth 2 -type f -name 'index.html' -o -name '*.png' | sed -n '1,120p'"

      - name: Verify Apache is reachable (optional)
        if: ${{ always() }}
        run: |
          echo "Deployed to https://rackevejogsi.hu (DNS/Apache must be configured)"
